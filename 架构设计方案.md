# 总体原则（先定调）

先能用，再好用，最后才聪明

所有设计都服务于：
复现问题、统计问题、定位责任、沉淀经验

永远假设：
日后会被用来追责、复盘、做 PPT

# Phase 0：项目骨架（1 天）
## 目标

跑起来，有数据库，有基本页面。

## 实现

**前后端分离架构**

**前端 (Frontend)**:
- Vite + React + TypeScript
- Tailwind + shadcn/ui
- Fetch / Axios 与后端通信

**后端 (Backend)**:
- Node.js + Fastify (轻量、高性能)
- Prisma + SQLite (数据层)
- 纯 REST API 接口

**集成**：
- 前端构建产物 (dist) 可由后端静态托管，实现单端口部署 (简便)
- 也可 Nginx 反代 (传统)

环境变量规划 (.env)：
- `DATABASE_URL="file:./dev.db"` (未来可改为 mysql://...)
- `UPLOAD_DIR="C:\issue-collector-data\uploads"` (项目外绝对路径)
- `PORT=3000`

## 数据结构（最小可运行）
```prisma
enum IssueStatus {
  PENDING
  PROCESSING
  NEED_INFO
  RESOLVED
  CLOSED
}

model DeviceModel {
  id   Int    @id @default(autoincrement())
  name String @unique
}

model Issue {
  id        Int         @id @default(autoincrement())
  title     String
  description String
  status    IssueStatus @default(PENDING)

  modelId   Int
  model     DeviceModel @relation(fields: [modelId], references: [id])

  firmware  String?
  reporterName String // 提出人姓名（临时文本存储，未来可对接用户系统）
  contact   String? // 联系方式

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

## 交付物

本地启动后端服务，能通过 API 访问数据
SQLite 文件真实落盘

# Phase 1：问题提交通道（2～3 天）
## 目标

售后 / 同事能稳定把问题丢进来

## 功能

独立提交页（无登录，无门槛）

字段：
- 标题
- 描述
- 提出人姓名
- 联系方式
- 机型（下拉）
- 固件版本

## 实现要点

/submit 页面

API：POST /api/issues

机型从 DeviceModel 表读

安全最小集
- 基础速率限制（IP）
- 文本长度限制

## 交付物

手机 / 外网都能访问提交
一条问题能进入数据库

# Phase 2：附件系统（关键阶段，3～4 天）
## 目标

能复现问题，而不是只看到情绪

## 附件设计（优化版）
```prisma
enum AttachmentKind {
  IMAGE
  VIDEO
  LOG
  PCAP
  BINARY
  OTHER
}

model Attachment {
  id        Int      @id @default(autoincrement())
  filename  String   // 原始文件名
  path      String   // 存储路径 (相对 UPLOAD_DIR 的路径)
  mimeType  String
  size      Int
  sha256    String?  @index
  kind      AttachmentKind

  // 孤儿文件清理策略：
  // 定时任务检查：createdAt < 24h AND issueId IS NULL 的文件可删除
  issueId   Int?
  issue     Issue?   @relation(fields: [issueId], references: [id])
  
  createdAt DateTime @default(now())
}
```

## 文件策略

存储路径：
- 使用 `UPLOAD_DIR` 环境变量控制根目录 (项目外绝对路径)
- 内部结构：`YYYY/MM/{uuid}.{ext}` (必须重命名，防止文件名冲突)
- **代码规范**：严禁字符串拼接路径，必须使用 `path.join()` / `path.resolve()` 以兼容 Windows/Linux

访问方式：
`GET /api/uploads/[...path]` 流式返回

校验：
- 扩展名 + MIME 双校验
- 黑名单：exe / sh / php / js
- **大小无限制**

在线预览：
- 图片直接展示
- 其他文件提供下载（后续版本再考虑在线预览方案）

## 交付物

图片能看
日志能下
数据不会因重启丢失

# Phase 3：研发内部看板（3～5 天）
## 目标

这是研发每天打开的页面

## 页面结构

总览页 /issues
- 待处理数量
- 今日新增
- 按机型统计

列表页
- 状态筛选
- 机型筛选
- 时间排序

详情页 /issues/[id]

# Phase 4：评论 + 状态流转（灵魂部分，2～3 天）
## 评论设计（事件化）
```prisma
enum CommentType {
  MESSAGE
  STATUS_CHANGE
}

model Comment {
  id         Int      @id @default(autoincrement())
  type       CommentType @default(MESSAGE)
  content    String?
  isInternal Boolean @default(false)

  oldStatus  IssueStatus?
  newStatus  IssueStatus?
  
  // 记录操作人（重要：需知道是谁修改了状态）
  author     String   

  createdAt  DateTime @default(now())

  issueId    Int
  issue      Issue @relation(fields: [issueId], references: [id])
}
```

## 好处

时间线可复盘
状态变更有据可查（明确责任人）
后期统计不卡

## 交付物

类聊天流体验
状态变化自动生成记录（包含操作人姓名）

# Phase 5：搜索与统计（2 天）
## 目标

找得到旧问题，不再重复踩坑

## 搜索

标题 / 描述 LIKE
评论内容 LIKE
机型 / 状态联合筛选

## 统计

机型 × 状态
固件版本问题数
平均解决时长
**（保留统计图表功能，直观展示数据）**

# Phase 6：安全与稳定性加固（1～2 天）
## SQLite 实战配置
`PRAGMA journal_mode=WAL;` (提升并发性能)
`PRAGMA synchronous=NORMAL;`

## 数据库迁移准备
- 保持 Prisma Schema 数据库无关性
- Phase 7 容器化时，支持通过环境变量切换为 MySQL/PostgreSQL
- 届时只需修改 `provider = "mysql"` 并运行迁移即可

## 权限

上传接口限流
下载接口校验 issueId 是否存在

## 备份

每日 cron 复制 /app/data/db

# Phase 7：容器化部署（最后阶段，可选）
## 目标

实现 Docker 容器化部署，方便迁移和交付

## 实现

Dockerfile
docker-compose.yml
数据目录挂载

# Phase 8：未来规划（暂不实现）

## 通知

后续考虑使用邮箱实现通知（Webhook/Email）
