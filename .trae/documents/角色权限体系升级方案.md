# 角色权限体系升级方案

根据您的需求，我们将系统用户划分为两类核心角色：**售后人员 (SUPPORT)** 和 **研发人员 (DEVELOPER)**。同时保留 **管理员 (ADMIN)** 作为系统维护者（通常由研发主管兼任）。

## 1. 角色定义与职责

| 角色 | 标识代码 | 核心职责 | 权限范围 |
| :--- | :--- | :--- | :--- |
| **售后人员** | `SUPPORT` | **问题提出者/反馈者** | ✅ **提交问题**：录入故障详情、上传附件<br>✅ **进度追踪**：查看处理状态、公开回复<br>❌ **受限操作**：不可见内部备注/附件、不可修改优先级/状态、不可并案 |
| **研发人员** | `DEVELOPER` | **问题查看/归档者** | ✅ **全量查看**：可见所有内部技术备注和敏感附件<br>✅ **流程处理**：修改状态、设置优先级、严重程度<br>✅ **并案管理**：执行主/子案合并<br>✅ **内部沟通**：发送仅团队可见的内部备注 |
| **管理员** | `ADMIN` | **系统维护者** | ✅ **包含所有研发权限**<br>✅ **系统配置**：管理机型、自定义字段、用户账户管理 |

---

## 2. 详细权限矩阵

### A. 问题详情可见性
*   **SUPPORT**: 仅能看到基础故障描述、公开的回复记录、公开的附件。**无法看到**“内部管理”黄色区域（优先级、内部备注）。
*   **DEVELOPER/ADMIN**: 可以看到所有内容，包括标记为 `isInternal` 的技术分析文档和备注。

### B. 操作权限
*   **状态流转**: 
    *   `SUPPORT`: 仅可查看状态（如“处理中”、“已解决”），不可手动更改。
    *   `DEVELOPER`: 可自由流转状态（Pending -> In Progress -> Resolved -> Closed）。
*   **属性编辑**:
    *   `SUPPORT`: 提交后不可修改。
    *   `DEVELOPER`: 可随时调整“严重程度”、“优先级”、“问题分类”。
*   **并案处理**:
    *   `SUPPORT`: 不可见并案入口。
    *   `DEVELOPER`: 可执行并案操作。

---

## 3. 执行计划

### 第一步：数据库与后端适配
1.  **更新角色定义**: 明确 `User` 表的 `role` 字段支持 `SUPPORT`, `DEVELOPER`, `ADMIN`。
2.  **中间件升级**: 
    *   创建 `requireDeveloper` 中间件：拦截非研发人员对敏感接口（如修改状态、并案）的访问。
    *   调整 `issue.controller`：根据当前登录角色，智能过滤返回的数据（售后人员请求详情时，自动剔除内部数据）。

### 第二步：前端界面改造
1.  **登录分流**: 登录后根据角色存储权限标识。
2.  **详情页视图区分**:
    *   **售后视图**: 隐藏“内部管理”面板、隐藏“并案”按钮、隐藏“内部可见”勾选框（发评论默认公开）。
    *   **研发视图**: 完整展示所有管理工具，评论框默认勾选“内部可见”。

### 第三步：数据迁移与验证
1.  将现有账号 `yfdz` 设为 `ADMIN`（兼具研发权限）。
2.  创建一个测试用的售后账号（如 `support_test`）用于验收权限隔离效果。

---

**请评审此方案。如无异议，我将立即开始执行代码变更。**